#!/usr/bin/env node
/**
 * Script to identify the specific vulnerability reported by yarn audit
 * Run this locally to see what package has the vulnerability
 */

const { execSync } = require('child_process');

console.log('Running yarn audit to identify vulnerabilities...\n');

try {
  // Run yarn audit with JSON output
  const auditOutput = execSync('yarn audit --json', { 
    encoding: 'utf8',
    stdio: 'pipe'
  });
  
  const lines = auditOutput.trim().split('\n').filter(line => line.trim());
  const vulnerabilities = [];
  
  // Parse JSON lines from yarn audit output
  for (const line of lines) {
    try {
      const data = JSON.parse(line);
      
      // Check for vulnerability advisories
      if (data.type === 'auditAdvisory') {
        const advisory = data.data.advisory;
        vulnerabilities.push({
          severity: advisory.severity,
          title: advisory.title,
          package: advisory.module_name,
          patched_versions: advisory.patched_versions,
          vulnerable_versions: advisory.vulnerable_versions,
          id: advisory.id,
          url: advisory.url
        });
      }
      
      // Check for audit summary
      if (data.type === 'auditSummary') {
        const summary = data.data;
        console.log('=== AUDIT SUMMARY ===');
        console.log(`Total vulnerabilities: ${summary.vulnerabilities?.total || 0}`);
        console.log(`  Low: ${summary.vulnerabilities?.low || 0}`);
        console.log(`  Moderate: ${summary.vulnerabilities?.moderate || 0}`);
        console.log(`  High: ${summary.vulnerabilities?.high || 0}`);
        console.log(`  Critical: ${summary.vulnerabilities?.critical || 0}\n`);
      }
    } catch (e) {
      // Skip non-JSON lines
    }
  }
  
  if (vulnerabilities.length > 0) {
    console.log('=== VULNERABILITIES FOUND ===\n');
    vulnerabilities.forEach((vuln, index) => {
      console.log(`${index + 1}. ${vuln.package}`);
      console.log(`   Severity: ${vuln.severity}`);
      console.log(`   Title: ${vuln.title}`);
      console.log(`   Vulnerable versions: ${vuln.vulnerable_versions}`);
      console.log(`   Patched versions: ${vuln.patched_versions}`);
      console.log(`   Advisory ID: ${vuln.id}`);
      console.log(`   URL: ${vuln.url}\n`);
      
      // Suggest resolution
      if (vuln.patched_versions && vuln.patched_versions !== '<0.0.0') {
        console.log(`   ðŸ’¡ SUGGESTED FIX:`);
        console.log(`   Add to package.json resolutions:`);
        console.log(`   "${vuln.package}": "${vuln.patched_versions.replace(/[<>]/g, '')}"\n`);
      }
    });
  } else {
    console.log('No vulnerabilities found in JSON output. Running regular audit...\n');
    execSync('yarn audit', { stdio: 'inherit' });
  }
} catch (error) {
  console.error('Error running yarn audit:', error.message);
  console.log('\nTrying regular yarn audit...\n');
  try {
    execSync('yarn audit', { stdio: 'inherit' });
  } catch (e) {
    console.error('Could not run yarn audit');
  }
}

